---
- include: setup-RedHat.yml
  when: ansible_os_family == 'RedHat'

- name: Install Docker.
  package: name={{ docker_package }} state={{ docker_package_state }}

- name: Ensure Docker is started and enabled at boot.
  service:
    name: docker
    state: started
    enabled: yes
  register: result

- name: Install Docker Regisry.
  package: name={{ docker_registry }} state={{ docker_package_state }}

- name: "Create symbolic link /usr/lib/systemd/system/docker-registry to /usr/lib/systemd/system/docker-distribution.service"
  file:
    src: "/usr/lib/systemd/system/docker-distribution.service"
    dest: "/usr/lib/systemd/system/docker-registry.service"
    state: link
    owner: "root"
    group: "root"

- name: Ensure Docker registry is started and enabled at boot
  service:
    name: docker-registry
    state: started
    enabled: yes

- name: get the version of docker registry
  shell: yum list installed | grep docker-ce | awk '{print $2}' | cut -d'-' -f1 | cut -d':' -f2
  register: version
  changed_when: False
  args:
    warn: no

- name: locating docker registry
  shell: whereis docker | tr " " %
  register: path

- name: generate docker registry report
  shell: "{{ playbook_dir }}/report.sh docker {{ version.stdout }} N/A {{ path.stdout }} {{ ansible_fqdn }} success"
  delegate_to: localhost
  when: result|succeeded

- name: run test for docker-registry
  become: True
  become_user: root
  script: ./tests/registry_test.sh
  register: registry_test
  failed_when: "'Failed' in registry_test.stdout"

- debug: msg="{{ registry_test.stdout }}"
- debug: msg="{{ registry_test.stderr }}"
